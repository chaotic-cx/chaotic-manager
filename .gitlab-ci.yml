---
stages: [build]

build-builder:
  # Used to deploy a new base Docker image for building purposes
  # this one runs once per day via pipeline schedules
  stage: build
  image: docker:24-cli
  services:
    - name: docker:24-dind
      alias: docker-daemon
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE/builder:latest" ./builder-container
    - docker push "$CI_REGISTRY_IMAGE/builder:latest"
  tags: ["dind"]
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker-daemon:2375/
    DOCKER_TLS_CERTDIR: ""

build-manager:
  stage: build
  image: docker:24-cli
  services:
    - name: docker:24-dind
      alias: docker-daemon
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE/manager:latest" .
    - docker push "$CI_REGISTRY_IMAGE/manager:latest"
  tags: ["dind"]
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker-daemon:2375/
    DOCKER_TLS_CERTDIR: ""
  rules:
  - if: $UPDATE_BUILDER != "1"