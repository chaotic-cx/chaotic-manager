<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src=" https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js "></script>
    <script src=" https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js "></script>
    <link href=" https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css " rel="stylesheet">
</head>
<body style="margin: 0;">
    <div class="container">
        <div class="terminal" style="height: 100vh" id="terminal"></div>
    </div>
    <script>
        function setup() {
            var term = new Terminal({ scrollback: 9999999, disableStdin: true });
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));

            term.attachCustomKeyEventHandler((e) => {
                return false;
            });

            const xterm_resize_ob = new ResizeObserver(function (entries) {
                fitAddon.fit();
            });
            xterm_resize_ob.observe(document.getElementById('terminal'));
            fitAddon.fit();

            // Parse querystring
            var query = new URLSearchParams(window.location.search);

            var id = undefined;
            // Print error if there is no ID 
            if (!query.has('id') || !/^[a-zA-Z0-9-_]+$/.test(id = query.get("id"))) {
                term.writeln('\x1B[1;3;31mUrl is invalid or no ID provided. Did you copy the querystring?\x1B[0m ')
            }

            var url = "/api/logs/" + id;
            var timestamp = undefined;
            if (query.has("timestamp") && !/^\d+$/.test(timestamp = query.get("timestamp")))
                url += "/" + timestamp;

            var done = false;
            fetch(url).then(async (response) => {
                const reader = response.body.getReader();
                var err = false;
                while (!done && !err) {
                    await reader.read().then(({ done, value }) => {
                        if (done) {
                            done = true;
                        }
                        term.write(value);
                    }).catch((e) => {
                        err = true;
                    });
                }
            });
        }
        setup();
    </script>
</body>
</html>